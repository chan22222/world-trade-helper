<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì… í™˜ìœ¨ ê³„ì‚°ê¸°</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’±</text></svg>">
    <!-- API ì„¤ì • íŒŒì¼ ë¡œë“œ -->
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e88e5 0%, #0d47a1 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .calculator {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 18px;
                margin-bottom: 15px;
            }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 30px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ê³„ì‚°ê¸° ì„¹ì…˜ */
        .calculator-section {
            padding: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-end;  /* í•˜ë‹¨ ì •ë ¬ë¡œ ë†’ì´ ë§ì¶¤ */
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* í™˜ìœ¨ ìœ„ì ¯ */
        .rate-widget {
            background: linear-gradient(135deg, #1e88e5 0%, #0d47a1 100%);
            border-radius: 16px;
            padding: 25px;
            color: white;
            position: sticky;
            top: 20px;
        }

        .rate-widget-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rate-widget-date {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .rate-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .rate-item:last-child {
            margin-bottom: 0;
        }

        .rate-currency {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .rate-value {
            font-size: 24px;
            font-weight: 700;
        }

        .rate-label {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 3px;
        }

        .api-status {
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 15px;  /* ì•„ë˜ ì—¬ë°± ì¶”ê°€ */
            display: none;
        }

        .api-status.loading {
            display: block;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .api-status.success {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .api-status.cached {
            display: block;
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="date"],
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="date"]:focus,
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #1e88e5;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            padding-right: 40px;
        }

        .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #999;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .clear-btn:hover {
            background: #666;
        }

        /* ê³„ì‚°ê¸° ì„¹ì…˜ */
        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #1e88e5 0%, #0d47a1 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .result.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .result-header {
            color: #1e88e5;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 14px;
        }

        #resultList {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        @media (max-width: 768px) {
            #resultList {
                grid-template-columns: 1fr;
            }
        }

        .result-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
        }

        .result-item:hover {
            border-color: #1e88e5;
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.1);
        }

        .result-currency {
            font-size: 13px;
            color: #1e88e5;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .result-amount {
            font-size: 26px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .result-rate {
            font-size: 12px;
            color: #666;
        }

        .info-message {
            background: #e3f2fd;
            border-left: 3px solid #1e88e5;
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            line-height: 1.5;
        }

        .saved-dates {
            margin-top: 15px;
        }

        .saved-dates-toggle {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .saved-dates-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .saved-dates-list {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .saved-dates-list.show {
            display: block;
        }

        .saved-dates-title {
            font-weight: 600;
            color: white;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .saved-date-item {
            padding: 5px 8px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-date-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(3px);
        }

        .delete-date-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .delete-date-btn:hover {
            background: #c82333;
        }

        /* í™”í ì„ íƒ ë²„íŠ¼ (label ì˜†) */
        .currency-select-btn {
            display: inline-block;
            margin-left: 8px;
            padding: 4px 10px;
            background: #1e88e5;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: normal;
        }

        .currency-select-btn:hover {
            background: #0d47a1;
        }

        /* ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: #333;
        }

        .currency-search-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

        .currency-search-wrapper input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .currency-search-wrapper input:focus {
            outline: none;
            border-color: #1e88e5;
        }

        .currency-search-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #999;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .currency-search-clear:hover {
            background: #666;
        }

        .currency-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            align-content: start;
        }

        .currency-no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .currency-section-divider {
            grid-column: 1 / -1;
            font-size: 11px;
            color: #999;
            padding: 10px 0 5px;
            border-top: 1px solid #e0e0e0;
            margin-top: 5px;
        }

        .currency-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .currency-checkbox-item:hover {
            background: #e9ecef;
        }

        .currency-checkbox-item input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .currency-checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
            font-size: 13px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <h1>ìˆ˜ì… í™˜ìœ¨ ê³„ì‚°ê¸° (ê´€ì„¸ì²­ - UNIPASS API)</h1>

        <div class="main-content">
            <!-- ì™¼ìª½: ê³„ì‚°ê¸° ì„¹ì…˜ -->
            <div class="calculator-section">
                <div class="form-group">
                    <label for="date">ë‚ ì§œ</label>
                    <input type="date" id="date" required onchange="fetchRatesOnDateChange()">
                </div>

                <div id="api-status" class="api-status"></div>

                <div class="form-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="fromCurrency">
                            í†µí™” ì„ íƒ
                            <button type="button" class="currency-select-btn" onclick="openCurrencyModal()">í™”í ì„ íƒ</button>
                        </label>
                        <select id="fromCurrency">
                            <option value="KRW">ì› (KRW)</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="amount">ê¸ˆì•¡</label>
                        <div class="input-wrapper">
                            <input type="text" id="amount" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                            <button type="button" class="clear-btn" id="clearAmount">Ã—</button>
                        </div>
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculate()">ê³„ì‚°í•˜ê¸°</button>

                <div class="result" id="result">
                    <div class="result-header">í™˜ì „ ê²°ê³¼</div>
                    <div id="resultList"></div>
                </div>

                <div class="info-message" style="margin-top: 20px;">
                    ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ APIì—ì„œ ê¸°ì¤€í™˜ìœ¨ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.<br>
                    ë¶ˆëŸ¬ì˜¨ í™˜ìœ¨ì€ ìºì‹œì— ì €ì¥ë˜ì–´ ë‹¤ìŒë²ˆì—ëŠ” ì¦‰ì‹œ ë¡œë“œë©ë‹ˆë‹¤.
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: í™˜ìœ¨ ì •ë³´ ìœ„ì ¯ -->
            <div class="rate-widget">
                <div class="rate-widget-title">ê¸°ì¤€í™˜ìœ¨</div>
                <div class="rate-widget-date" id="widget-date">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>

                <!-- í™˜ìœ¨ í•­ëª©ë“¤ì€ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->

                <!-- ì €ì¥ëœ ë‚ ì§œ ëª©ë¡ -->
                <div class="saved-dates">
                    <button class="saved-dates-toggle" onclick="toggleSavedDates()">
                        ì €ì¥ëœ í™˜ìœ¨ ë‚ ì§œ ë³´ê¸° (<span id="saved-count">0</span>)
                    </button>
                    <div class="saved-dates-list" id="saved-dates-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- í™”í ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="currencyModal" onclick="closeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">ìì£¼ ì“°ëŠ” í™”í ì„ íƒ</h2>
                <button class="modal-close-btn" onclick="closeCurrencyModal()">&times;</button>
            </div>
            <!-- ê²€ìƒ‰ì°½ -->
            <div class="currency-search-wrapper">
                <input type="text" id="currencySearch" placeholder="í†µí™”ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰ (ì˜ˆ: ë‹¬ëŸ¬, USD)" oninput="filterCurrencies()">
                <button type="button" class="currency-search-clear" id="clearCurrencySearch" onclick="clearCurrencySearch()">Ã—</button>
            </div>
            <div id="currency-checkboxes" class="currency-checkboxes">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>
    </div>

    <script>
        // í˜„ì¬ ë¡œë“œëœ í™˜ìœ¨ ë°ì´í„°
        let currentRates = null;
        let allCurrencies = {}; // ëª¨ë“  í™”í ì •ë³´ ì €ì¥
        let selectedCurrencies = ['USD', 'EUR', 'CHF']; // ê¸°ë³¸ ì„ íƒëœ í™”í

        // ì´ˆê¸°í™”
        document.getElementById('date').valueAsDate = new Date();

        // localStorageì—ì„œ ì„ í˜¸ í™”í ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSelectedCurrencies() {
            const saved = localStorage.getItem(CONFIG.SELECTED_CURRENCIES_KEY);
            if (saved) {
                selectedCurrencies = JSON.parse(saved);
            }

            // í™”í ì´ë¦„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            const savedNames = localStorage.getItem(CONFIG.CURRENCY_NAMES_KEY);
            if (savedNames) {
                allCurrencies = JSON.parse(savedNames);
            }
        }

        // localStorageì— ì„ í˜¸ í™”í ì €ì¥
        function saveSelectedCurrencies() {
            localStorage.setItem(CONFIG.SELECTED_CURRENCIES_KEY, JSON.stringify(selectedCurrencies));
        }

        // ëª¨ë‹¬ ì—´ê¸°
        function openCurrencyModal() {
            const modal = document.getElementById('currencyModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ë°©ì§€
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeCurrencyModal() {
            const modal = document.getElementById('currencyModal');
            modal.classList.remove('show');
            document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µì›
            // ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
            const searchInput = document.getElementById('currencySearch');
            if (searchInput) {
                searchInput.value = '';
            }
        }

        // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
        function closeModalOnOverlay(event) {
            if (event.target.id === 'currencyModal') {
                closeCurrencyModal();
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCurrencyModal();
            }
        });

        // ìì£¼ ì“°ëŠ” í†µí™” ëª©ë¡
        const POPULAR_CURRENCIES = ['USD', 'EUR', 'JPY', 'CNY', 'GBP', 'AUD', 'CAD', 'CHF', 'HKD', 'SGD', 'THB', 'VND', 'TWD', 'IDR', 'MYR', 'PHP', 'INR'];

        // ì²´í¬ë°•ìŠ¤ ë Œë”ë§
        function renderCurrencyCheckboxes(searchTerm = '') {
            const container = document.getElementById('currency-checkboxes');
            const clearBtn = document.getElementById('clearCurrencySearch');

            // X ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            if (clearBtn) {
                if (searchTerm) {
                    clearBtn.style.display = 'flex';
                } else {
                    clearBtn.style.display = 'none';
                }
            }

            if (Object.keys(allCurrencies).length === 0) {
                container.innerHTML = '<p class="currency-no-results">ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ í™˜ìœ¨ì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”</p>';
                return;
            }

            // ê²€ìƒ‰ì–´ë¡œ í•„í„°ë§
            const search = searchTerm.toLowerCase();
            let filteredCurrencies = Object.keys(allCurrencies).filter(code => {
                if (!search) return true;
                const name = getDetailedCurrencyName(code).toLowerCase();
                return code.toLowerCase().includes(search) || name.includes(search);
            });

            // ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ
            if (filteredCurrencies.length === 0) {
                container.innerHTML = '<p class="currency-no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            // ì •ë ¬: ìì£¼ ì“°ëŠ” í†µí™” ë¨¼ì €, ë‚˜ë¨¸ì§€ëŠ” ì•ŒíŒŒë²³ìˆœ
            filteredCurrencies.sort((a, b) => {
                const aPopular = POPULAR_CURRENCIES.indexOf(a);
                const bPopular = POPULAR_CURRENCIES.indexOf(b);
                if (aPopular !== -1 && bPopular !== -1) return aPopular - bPopular;
                if (aPopular !== -1) return -1;
                if (bPopular !== -1) return 1;
                return a.localeCompare(b);
            });

            let html = '';
            const popularCount = POPULAR_CURRENCIES.filter(c => allCurrencies[c] && filteredCurrencies.includes(c)).length;

            filteredCurrencies.forEach((code, index) => {
                // ìì£¼ ì“°ëŠ” í†µí™”ì™€ ê¸°íƒ€ í†µí™” êµ¬ë¶„ì„ 
                if (!searchTerm && index === popularCount) {
                    html += '<div class="currency-section-divider">ê¸°íƒ€ í†µí™”</div>';
                }

                const detailedName = getDetailedCurrencyName(code);
                const checked = selectedCurrencies.includes(code) ? 'checked' : '';
                html += `
                    <div class="currency-checkbox-item">
                        <input type="checkbox" id="curr-${code}" value="${code}" ${checked} onchange="updateCurrencySelections()">
                        <label for="curr-${code}">${detailedName} (${code})</label>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ê²€ìƒ‰ í•„í„°ë§
        function filterCurrencies() {
            const searchInput = document.getElementById('currencySearch');
            renderCurrencyCheckboxes(searchInput.value);
        }

        // ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
        function clearCurrencySearch() {
            const searchInput = document.getElementById('currencySearch');
            searchInput.value = '';
            renderCurrencyCheckboxes('');
            searchInput.focus();
        }

        // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ì²˜ë¦¬
        function updateCurrencySelections() {
            const checkboxes = document.querySelectorAll('#currency-checkboxes input[type="checkbox"]');
            selectedCurrencies = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedCurrencies.push(checkbox.value);
                }
            });

            saveSelectedCurrencies();
            updateCurrencyDropdown();
            updateRateWidget();
        }

        // í†µí™” ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateCurrencyDropdown() {
            const dropdown = document.getElementById('fromCurrency');
            const currentValue = dropdown.value;

            // KRWëŠ” í•­ìƒ í¬í•¨
            let html = '<option value="KRW">ì› (KRW)</option>';

            selectedCurrencies.forEach(code => {
                const detailedName = getDetailedCurrencyName(code);
                html += `<option value="${code}">${detailedName} (${code})</option>`;
            });

            dropdown.innerHTML = html;

            // ì´ì „ ì„ íƒ ê°’ ìœ ì§€ (ê°€ëŠ¥í•œ ê²½ìš°)
            if (currentValue === 'KRW' || selectedCurrencies.includes(currentValue)) {
                dropdown.value = currentValue;
            }
        }

        // í™˜ìœ¨ ìœ„ì ¯ ì—…ë°ì´íŠ¸ (ì„ íƒëœ í™”íë§Œ í‘œì‹œ)
        function updateRateWidget() {
            const widgetContainer = document.querySelector('.rate-widget');
            const date = document.getElementById('date').value;

            // ê¸°ì¡´ í™˜ìœ¨ í•­ëª© ì œê±° (ì €ì¥ëœ ë‚ ì§œ ë¶€ë¶„ ì œì™¸)
            const existingItems = widgetContainer.querySelectorAll('.rate-item');
            existingItems.forEach(item => item.remove());

            if (!currentRates || selectedCurrencies.length === 0) {
                return;
            }

            // ë‚ ì§œ í‘œì‹œ ë°”ë¡œ ë‹¤ìŒì— í™˜ìœ¨ í•­ëª© ì¶”ê°€
            const dateElement = document.getElementById('widget-date');

            selectedCurrencies.forEach(code => {
                const rate = currentRates[code];
                const detailedName = getDetailedCurrencyName(code);
                const symbol = getCurrencySymbol(code);

                const rateItem = document.createElement('div');
                rateItem.className = 'rate-item';
                rateItem.innerHTML = `
                    <div class="rate-currency">${symbol} ${detailedName} (${code})</div>
                    <div class="rate-value">${rate ? rate.toFixed(2) : '-'}</div>
                    <div class="rate-label">ì›</div>
                `;

                // ì €ì¥ëœ ë‚ ì§œ ì„¹ì…˜ ì „ì— ì‚½ì…
                const savedDatesSection = widgetContainer.querySelector('.saved-dates');
                widgetContainer.insertBefore(rateItem, savedDatesSection);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        loadSelectedCurrencies();

        // X ë²„íŠ¼ í´ë¦­ ì‹œ ê¸ˆì•¡ ì§€ìš°ê¸°
        const clearBtn = document.getElementById('clearAmount');
        document.getElementById('clearAmount').addEventListener('click', function() {
            document.getElementById('amount').value = '';
            clearBtn.style.display = 'none';
            document.getElementById('amount').focus();
        });

        // ê¸ˆì•¡ ì…ë ¥ í•„ë“œì— ì‰¼í‘œ ì¶”ê°€
        const amountInput = document.getElementById('amount');

        // X ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
        function updateClearButton() {
            if (amountInput.value) {
                clearBtn.style.display = 'flex';
            } else {
                clearBtn.style.display = 'none';
            }
        }

        amountInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/,/g, '');
            updateClearButton();

            // ìˆ«ì, ì†Œìˆ˜ì ë§Œ í—ˆìš©
            if (value && !/^[\d.]*$/.test(value)) {
                value = value.replace(/[^\d.]/g, '');
            }

            // ì†Œìˆ˜ì ì´ ìˆëŠ”ì§€ í™•ì¸
            if (value.includes('.')) {
                const parts = value.split('.');
                const integerPart = parts[0];
                const decimalPart = parts[1] || '';

                // ì •ìˆ˜ ë¶€ë¶„ì—ë§Œ ì‰¼í‘œ ì¶”ê°€
                if (integerPart) {
                    const formatted = parseInt(integerPart).toLocaleString('en-US');
                    e.target.value = formatted + '.' + decimalPart;
                } else {
                    e.target.value = '.' + decimalPart;
                }
            } else if (value && !isNaN(value)) {
                e.target.value = parseInt(value).toLocaleString('en-US');
            } else {
                e.target.value = value;
            }
        });

        amountInput.addEventListener('blur', function(e) {
            let value = e.target.value.replace(/,/g, '');
            if (value && !isNaN(value) && value !== '.') {
                e.target.value = parseFloat(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            updateClearButton();
        });

        amountInput.addEventListener('focus', function(e) {
            updateClearButton();
        });

        // ìœ„ì ¯ ì—…ë°ì´íŠ¸
        function updateWidget(date, rates) {
            document.getElementById('widget-date').textContent = date;

            // ê³„ì‚°ì— ì‚¬ìš©í•  í˜„ì¬ í™˜ìœ¨ ì €ì¥
            currentRates = rates;

            // ì²´í¬ë°•ìŠ¤ì™€ ìœ„ì ¯ ì—…ë°ì´íŠ¸
            renderCurrencyCheckboxes();
            updateCurrencyDropdown();
            updateRateWidget();
        }

        // ë‚ ì§œ ë³€ê²½ ì‹œ í™˜ìœ¨ ìë™ ë¶ˆëŸ¬ì˜¤ê¸° (ìºì‹œ í™•ì¸ í›„ API í˜¸ì¶œ)
        function fetchRatesOnDateChange() {
            const date = document.getElementById('date').value;

            if (!date) {
                return;
            }

            const key = `${CONFIG.CACHE_PREFIX}${date}`;
            const cachedRates = localStorage.getItem(key);

            // ìºì‹œì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìºì‹œ ì‚¬ìš©
            if (cachedRates) {
                const rates = JSON.parse(cachedRates);
                updateWidget(date, rates);
                showStatus('cached', `ìºì‹œì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ (${date})`);
                return;
            }

            // ìºì‹œì— ì—†ìœ¼ë©´ API í˜¸ì¶œ
            fetchRatesFromAPI(date);
        }

        // API ìƒíƒœ í‘œì‹œ
        function showStatus(type, message) {
            const statusEl = document.getElementById('api-status');
            statusEl.className = `api-status ${type}`;
            statusEl.textContent = message;

            // ì„±ê³µ/ìºì‹œ ë©”ì‹œì§€ëŠ” 3ì´ˆ í›„ ìˆ¨ê¹€
            if (type === 'success' || type === 'cached') {
                setTimeout(() => {
                    statusEl.className = 'api-status';
                }, 3000);
            }
        }

        // XML ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ (API ì‘ë‹µìš©)
        function processXMLData(text, date) {
            console.group('ğŸ“¦ XML ë°ì´í„° ì²˜ë¦¬ ì¤‘ (API ì‘ë‹µ)');
            console.log('ğŸ“ ì‘ë‹µ ë°ì´í„° ê¸¸ì´:', text.length, 'bytes');
            console.log('ğŸ“„ ì‘ë‹µ ë°ì´í„° ì‹œì‘ ë¶€ë¶„:', text.substring(0, 300));

            // XML íŒŒì‹±
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, 'text/xml');

            // íŒŒì‹± ì—ëŸ¬ ì²´í¬
            const parseError = xmlDoc.querySelector('parsererror');
            if (parseError) {
                console.error('âŒ XML íŒŒì‹± ì‹¤íŒ¨');
                console.error('íŒŒì‹± ì—ëŸ¬ ë‚´ìš©:', parseError.textContent);
                console.error('ì›ë³¸ ë°ì´í„°:', text.substring(0, 500));
                console.groupEnd();
                throw new Error('XML íŒŒì‹± ì˜¤ë¥˜: ' + parseError.textContent);
            }

            // API ì—ëŸ¬ ì²´í¬
            const resultCode = xmlDoc.querySelector('resultCode');
            const resultMsg = xmlDoc.querySelector('resultMsg');

            console.log('ğŸ” API ì‘ë‹µ ì½”ë“œ:', resultCode?.textContent || 'ì—†ìŒ');
            console.log('ğŸ“‹ API ì‘ë‹µ ë©”ì‹œì§€:', resultMsg?.textContent || 'ì—†ìŒ');

            if (resultCode && resultCode.textContent !== '00') {
                const errorMsg = resultMsg?.textContent || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                console.error('âŒ API ì—ëŸ¬ ë°œìƒ');
                console.error('ì—ëŸ¬ ì½”ë“œ:', resultCode.textContent);
                console.error('ì—ëŸ¬ ë©”ì‹œì§€:', errorMsg);
                console.groupEnd();

                // ì—ëŸ¬ ì½”ë“œë³„ ìì„¸í•œ ì„¤ëª…
                let detailedError = `API ì˜¤ë¥˜ [${resultCode.textContent}]: ${errorMsg}\n\n`;
                if (resultCode.textContent === '30') {
                    detailedError += 'ì›ì¸: ë“±ë¡ë˜ì§€ ì•Šì€ ì„œë¹„ìŠ¤ í‚¤ì´ê±°ë‚˜ í™œì„±í™”ë˜ì§€ ì•Šì€ í‚¤ì…ë‹ˆë‹¤.';
                } else if (resultCode.textContent === '31') {
                    detailedError += 'ì›ì¸: ì¼ì¼ íŠ¸ë˜í”½ ì œí•œì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.';
                } else if (resultCode.textContent === '32') {
                    detailedError += 'ì›ì¸: API ì„œë¹„ìŠ¤ê°€ ì¼ì‹œì ìœ¼ë¡œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                }

                showStatus('error', detailedError);
                throw new Error(detailedError);
            }

            // í™˜ìœ¨ ë°ì´í„° ì¶”ì¶œ (APIëŠ” ê¸°ì¡´ í˜•ì‹ ì‚¬ìš©)
            const items = xmlDoc.querySelectorAll('item');
            console.log('ğŸ“Š í™˜ìœ¨ ë°ì´í„° ê°œìˆ˜:', items.length, 'ê°œ');

            if (items.length === 0) {
                console.warn('âš ï¸ í™˜ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                console.log('ê°€ëŠ¥í•œ ì›ì¸:');
                console.log('  - ì£¼ë§ ë˜ëŠ” ê³µíœ´ì¼ ë‚ ì§œ');
                console.log('  - ì•„ì§ ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì€ ë¯¸ë˜ ë‚ ì§œ');
                console.log('  - ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹');
                console.groupEnd();
                showStatus('error', 'í•´ë‹¹ ë‚ ì§œì˜ í™˜ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (ì£¼ë§/ê³µíœ´ì¼ ë˜ëŠ” ë°ì´í„° ë¯¸ì œê³µ ë‚ ì§œ)');
                return null;
            }

            // í†µí™”ë³„ í™˜ìœ¨ ë§µí•‘ (API í˜•ì‹: currSgn, curr, fxrt)
            const rates = {};
            const currencyNames = {};

            items.forEach((item, index) => {
                const currCode = item.querySelector('currSgn')?.textContent;
                const currName = item.querySelector('curr')?.textContent;
                const baseRate = parseFloat(item.querySelector('fxrt')?.textContent);

                if (currCode && !isNaN(baseRate)) {
                    rates[currCode] = baseRate;
                    currencyNames[currCode] = currName || currCode;

                    if (index < 5) {
                        console.log(`  ${index + 1}. ${currCode}: ${baseRate} (${currName})`);
                    }
                }
            });

            if (items.length > 5) {
                console.log(`  ... ì™¸ ${items.length - 5}ê°œ í†µí™”`);
            }

            // localStorageì— ìºì‹œ ì €ì¥
            const key = `${CONFIG.CACHE_PREFIX}${date}`;
            localStorage.setItem(key, JSON.stringify(rates));
            console.log('ğŸ’¾ ìºì‹œ ì €ì¥ ì™„ë£Œ:', key);

            // í™”í ì´ë¦„ ì •ë³´ë„ ì €ì¥
            localStorage.setItem(CONFIG.CURRENCY_NAMES_KEY, JSON.stringify(currencyNames));

            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            allCurrencies = currencyNames;

            // ìœ„ì ¯ ì—…ë°ì´íŠ¸
            updateWidget(date, rates);

            showStatus('success', 'APIì—ì„œ í™˜ìœ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ (' + items.length + 'ê°œ í†µí™”)');
            updateSavedDatesList();

            console.log('âœ… API ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ');
            console.groupEnd();

            return rates;
        }

        // JSON ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ (ì›¹ íŒŒì‹±ìš©)
        function processJSONData(jsonData, date) {
            console.group('ğŸ“¦ JSON ë°ì´í„° ì²˜ë¦¬ ì¤‘ (ì›¹ íŒŒì‹±)');

            const rates = {};
            const currencyNames = {};

            // ì›¹ íŒŒì‹± í˜•ì‹: currCd, currNm, weekFxrt
            if (jsonData && jsonData.items) {
                console.log('ğŸ“Š JSON ë°ì´í„° ë°œê²¬! ë ˆì½”ë“œ ìˆ˜:', jsonData.items.length);
                console.log('ğŸ“… ì¡°íšŒ ê¸°ê°„:', jsonData.aplyDtStrtDd, '~', jsonData.aplyDtEndDd);

                jsonData.items.forEach(record => {
                    const currCode = record.currCd;  // ì›¹: currCd
                    const currName = record.currNm;  // ì›¹: currNm
                    const baseRate = parseFloat(record.weekFxrt);  // ì›¹: weekFxrt

                    if (currCode && !isNaN(baseRate)) {
                        rates[currCode] = baseRate;
                        currencyNames[currCode] = currName || currCode;
                    }
                });
            }
            // ì´ì „ ë²„ì „ í˜¸í™˜ì„± (recordList í˜•ì‹)
            else if (jsonData && jsonData.recordList) {
                console.log('ğŸ“Š JSON ë°ì´í„° ë°œê²¬! (recordList) ë ˆì½”ë“œ ìˆ˜:', jsonData.recordList.length);

                jsonData.recordList.forEach(record => {
                    const currCode = record.currSgn;  // API í˜•ì‹
                    const currName = record.curr;
                    const baseRate = parseFloat(record.fxrt);

                    if (currCode && !isNaN(baseRate)) {
                        rates[currCode] = baseRate;
                        currencyNames[currCode] = currName || currCode;
                    }
                });
            }

            console.log('ğŸ¯ íŒŒì‹±ëœ í™˜ìœ¨ ìˆ˜:', Object.keys(rates).length);

            if (Object.keys(rates).length > 0) {
                // ìºì‹œì— ì €ì¥
                const key = `${CONFIG.CACHE_PREFIX}${date}`;
                localStorage.setItem(key, JSON.stringify(rates));
                localStorage.setItem(CONFIG.CURRENCY_NAMES_KEY, JSON.stringify(currencyNames));

                allCurrencies = currencyNames;
                updateWidget(date, rates);

                showStatus('success', `ì›¹ íŒŒì‹±ìœ¼ë¡œ í™˜ìœ¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤ (${Object.keys(rates).length}ê°œ í†µí™”)`);
                updateSavedDatesList();

                console.log('âœ… ì›¹ íŒŒì‹± ì„±ê³µ!');
                console.groupEnd();
                return true;
            }

            console.groupEnd();
            return false;
        }

        // ì›¹ íŒŒì‹±ìœ¼ë¡œ í™˜ìœ¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function fetchRatesByParsing(date) {
            console.group('ğŸŒ ì›¹ íŒŒì‹± ëª¨ë“œë¡œ ì „í™˜');
            console.log('ğŸ“… ìš”ì²­ ë‚ ì§œ:', date);

            showStatus('loading', 'ì›¹ íŒŒì‹±ìœ¼ë¡œ í™˜ìœ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

            // UNIPASS ì›¹ í˜ì´ì§€ URL êµ¬ì„±
            const pageIndex = 1;
            const pageUnit = 100;
            const weekFxrtTpcd = '2';  // 2: ìˆ˜ì…
            const timestamp = Date.now();

            // ê³µì‹ ì›¹í˜ì´ì§€ì™€ ë™ì¼í•œ URL í˜•ì‹
            const unipassUrl = `https://unipass.customs.go.kr/csp/myc/bsopspptinfo/dclrSpptInfo/WeekFxrtQryCtr/retrieveWeekFxrt.do?pageIndex=${pageIndex}&pageUnit=${pageUnit}&aplyDt=${date}&weekFxrtTpcd=${weekFxrtTpcd}&undefined=${date}&_=${timestamp}`;

            console.log('ğŸ”— íŒŒì‹± URL:', unipassUrl);

            // CORS í”„ë¡ì‹œë¥¼ í†µí•´ ì›¹ í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°
            const proxyUrls = [
                `https://corsproxy.io/?url=${unipassUrl}`,  // corsproxy.ioëŠ” ?url= í˜•ì‹ ì‚¬ìš©
                `https://api.allorigins.win/get?url=${encodeURIComponent(unipassUrl)}`,
                `https://cors-anywhere.herokuapp.com/${unipassUrl}`
            ];

            let attemptCount = 0;

            function tryNextProxy() {
                if (attemptCount >= proxyUrls.length) {
                    console.error('âŒ ëª¨ë“  íŒŒì‹± í”„ë¡ì‹œ ì‹¤íŒ¨');
                    showStatus('error', 'ì›¹ íŒŒì‹±ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    console.groupEnd();
                    return;
                }

                const proxyUrl = proxyUrls[attemptCount];
                console.log(`ğŸ”„ íŒŒì‹± í”„ë¡ì‹œ ì‹œë„ ${attemptCount + 1}/${proxyUrls.length}:`, proxyUrl);

                fetch(proxyUrl)
                    .then(response => {
                        console.log('ğŸ“¥ íŒŒì‹± í”„ë¡ì‹œ ì‘ë‹µ:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        // allorigins.winì€ JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
                        if (proxyUrl.includes('allorigins.win')) {
                            try {
                                const json = JSON.parse(text);
                                text = json.contents;
                            } catch (e) {
                                console.log('allorigins ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨');
                            }
                        }

                        console.log('âœ… ì›¹ í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸° ì„±ê³µ! ê¸¸ì´:', text.length);

                        // JSON ì‘ë‹µì¸ì§€ í™•ì¸
                        try {
                            const jsonData = JSON.parse(text);

                            // processJSONData í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì²˜ë¦¬
                            if (processJSONData(jsonData, date)) {
                                console.groupEnd();  // fetchRatesByParsing ê·¸ë£¹ ì¢…ë£Œ
                                return;  // ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì¢…ë£Œ
                            }
                        } catch (e) {
                            console.log('JSON íŒŒì‹± ì‹¤íŒ¨:', e.message);
                        }

                        // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ í”„ë¡ì‹œ ì‹œë„
                        console.warn('âš ï¸ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨, ë‹¤ìŒ í”„ë¡ì‹œ ì‹œë„...');
                        attemptCount++;
                        tryNextProxy();
                    })
                    .catch(error => {
                        console.error(`âŒ í”„ë¡ì‹œ ${attemptCount + 1} ì‹¤íŒ¨:`, error.message);
                        attemptCount++;
                        tryNextProxy();
                    });
            }

            tryNextProxy();
        }

        // APIì—ì„œ í™˜ìœ¨ ë¶ˆëŸ¬ì˜¤ê¸° (íŒŒì‹± ìš°ì„ , ì‹¤íŒ¨ ì‹œ PHP í”„ë¡ì‹œ API)
        function fetchRatesFromAPI(date) {
            console.group('ğŸ” í™˜ìœ¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘');
            console.log('ğŸ“… ìš”ì²­ ë‚ ì§œ:', date);

            // 1ìˆœìœ„: ì›¹ íŒŒì‹± ì‹œë„
            showStatus('loading', 'ì›¹ í˜ì´ì§€ì—ì„œ í™˜ìœ¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...');

            // ì›¹ íŒŒì‹± ë¨¼ì € ì‹œë„
            fetchRatesByParsingWithFallback(date);
        }

        // ì›¹ íŒŒì‹± (ì‹¤íŒ¨ ì‹œ PHP í”„ë¡ì‹œ APIë¡œ í´ë°±)
        function fetchRatesByParsingWithFallback(date) {
            console.log('1ï¸âƒ£ PHP í”„ë¡ì‹œë¡œ ì›¹ íŒŒì‹± ìš°ì„  ì‹œë„');

            // PHP í”„ë¡ì‹œë¥¼ í†µí•´ UNIPASS ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const phpProxyUrl = `proxy_final.php?date=${date}`;

            fetch(phpProxyUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`PHP í”„ë¡ì‹œ ì‹¤íŒ¨: ${response.status}`);
                    }
                    return response.json(); // PHP í”„ë¡ì‹œëŠ” JSON ë°˜í™˜
                })
                .then(jsonData => {
                    console.log('ğŸ“¥ PHP í”„ë¡ì‹œ ì‘ë‹µ:', jsonData);

                    // ì—ëŸ¬ ì²´í¬
                    if (jsonData.error) {
                        throw new Error(jsonData.message || 'PHP í”„ë¡ì‹œ ì—ëŸ¬');
                    }

                    // processJSONDataì™€ í˜¸í™˜ë˜ëŠ” í˜•ì‹ìœ¼ë¡œ ì²˜ë¦¬
                    // items í˜•ì‹ (ì›¹ íŒŒì‹±) ë˜ëŠ” recordList í˜•ì‹ (API)
                    if ((jsonData.items && jsonData.items.length > 0) ||
                        (jsonData.recordList && jsonData.recordList.length > 0)) {

                        if (processJSONData(jsonData, date)) {
                            console.log('âœ… PHP í”„ë¡ì‹œ ì›¹ íŒŒì‹± ì„±ê³µ!');
                            console.groupEnd();
                            return;
                        }
                    }

                    throw new Error('ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨');
                })
                .catch(error => {
                    console.warn('âš ï¸ PHP í”„ë¡ì‹œ ì›¹ íŒŒì‹± ì‹¤íŒ¨:', error.message);
                    console.log('2ï¸âƒ£ ì¼ë°˜ CORS í”„ë¡ì‹œë¡œ ì¬ì‹œë„...');

                    // 2ìˆœìœ„: ì¼ë°˜ CORS í”„ë¡ì‹œ ì‹œë„
                    const pageIndex = 1;
                    const pageUnit = 100;
                    const weekFxrtTpcd = '2';  // 2: ìˆ˜ì…
                    const timestamp = Date.now();

                    const unipassUrl = `https://unipass.customs.go.kr/csp/myc/bsopspptinfo/dclrSpptInfo/WeekFxrtQryCtr/retrieveWeekFxrt.do?pageIndex=${pageIndex}&pageUnit=${pageUnit}&aplyDt=${date}&weekFxrtTpcd=${weekFxrtTpcd}&undefined=${date}&_=${timestamp}`;
                    const proxyUrl = `https://corsproxy.io/?url=${unipassUrl}`;

                    fetch(proxyUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            try {
                                const jsonData = JSON.parse(text);

                                if (processJSONData(jsonData, date)) {
                                    console.log('âœ… CORS í”„ë¡ì‹œ ì„±ê³µ!');
                                    console.groupEnd();
                                    return;
                                }
                                throw new Error('ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨');
                            } catch (e) {
                                throw new Error('JSON íŒŒì‹± ì‹¤íŒ¨: ' + e.message);
                            }
                        })
                        .catch(error2 => {
                            console.warn('âš ï¸ CORS í”„ë¡ì‹œë„ ì‹¤íŒ¨:', error2.message);
                            console.log('3ï¸âƒ£ XML APIë¡œ í´ë°±...');

                            // 3ìˆœìœ„: PHP í”„ë¡ì‹œ API (XML) ì‹œë„
                            tryPhpProxyAPI(date);
                        });
                });
        }

        // PHP í”„ë¡ì‹œ API í˜¸ì¶œ (ê³µê³µë°ì´í„° API)
        function tryPhpProxyAPI(date) {
            const serviceKey = CONFIG.SERVICE_KEY;

            showStatus('loading', 'ê³µê³µë°ì´í„° APIë¡œ ì¬ì‹œë„ ì¤‘...');

            if (!serviceKey) {
                console.warn('âš ï¸ ì„œë¹„ìŠ¤ í‚¤ ì—†ìŒ - ë‹¤ë¥¸ íŒŒì‹± í”„ë¡ì‹œ ì‹œë„');
                // ì„œë¹„ìŠ¤ í‚¤ê°€ ì—†ìœ¼ë©´ ë‹¤ë¥¸ íŒŒì‹± í”„ë¡ì‹œë“¤ ì‹œë„
                fetchRatesByParsing(date);
                return;
            }

            // ìƒˆë¡œìš´ proxy_api.php ì‚¬ìš©
            const phpProxyUrl = `proxy_api.php?date=${date}&weekFxrtTpcd=2&serviceKey=${encodeURIComponent(serviceKey)}`;

            fetch(phpProxyUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API í”„ë¡ì‹œ ì‹¤íŒ¨: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ“¥ ê³µê³µë°ì´í„° API ì‘ë‹µ:', data);

                    if (data.error) {
                        throw new Error(data.message || 'API ì˜¤ë¥˜');
                    }

                    // recordListê°€ ìˆìœ¼ë©´ ì²˜ë¦¬
                    if (data.recordList && data.recordList.length > 0) {
                        console.log('âœ… ê³µê³µë°ì´í„° API ì„±ê³µ!');

                        // processJSONData í˜•ì‹ìœ¼ë¡œ ì²˜ë¦¬
                        if (processJSONData(data, date)) {
                            console.groupEnd();
                            return;
                        }
                    }

                    throw new Error('API ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨');
                })
                .catch(error => {
                    console.warn('âš ï¸ ê³µê³µë°ì´í„° API ì‹¤íŒ¨:', error.message);
                    console.log('4ï¸âƒ£ ë‹¤ë¥¸ íŒŒì‹± í”„ë¡ì‹œë“¤ ì‹œë„...');

                    // ë§ˆì§€ë§‰: ë‹¤ë¥¸ íŒŒì‹± í”„ë¡ì‹œë“¤ ì‹œë„
                    fetchRatesByParsing(date);
                });
        }


        // ì €ì¥ëœ ë‚ ì§œ í† ê¸€
        function toggleSavedDates() {
            const list = document.getElementById('saved-dates-list');
            list.classList.toggle('show');
        }

        // ì €ì¥ëœ ë‚ ì§œ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateSavedDatesList() {
            const container = document.getElementById('saved-dates-list');
            const countSpan = document.getElementById('saved-count');
            const dates = [];

            // localStorageì—ì„œ ëª¨ë“  í™˜ìœ¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(CONFIG.CACHE_PREFIX)) {
                    const date = key.replace(CONFIG.CACHE_PREFIX, '');
                    dates.push(date);
                }
            }

            // ê°œìˆ˜ ì—…ë°ì´íŠ¸
            countSpan.textContent = dates.length;

            if (dates.length === 0) {
                container.innerHTML = '';
                return;
            }

            // ë‚ ì§œ ì •ë ¬ (ìµœì‹ ìˆœ)
            dates.sort().reverse();

            let html = '<div class="saved-dates-title">ì €ì¥ëœ í™˜ìœ¨ ë‚ ì§œ</div>';
            dates.forEach(date => {
                html += `
                    <div class="saved-date-item">
                        <span onclick="loadSavedDate('${date}')">${date}</span>
                        <button class="delete-date-btn" onclick="deleteSavedDate('${date}', event)">ì‚­ì œ</button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ì €ì¥ëœ ë‚ ì§œ í´ë¦­ ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSavedDate(date) {
            document.getElementById('date').value = date;
            fetchRatesOnDateChange();
        }

        // ì €ì¥ëœ ë‚ ì§œ ì‚­ì œ
        function deleteSavedDate(date, event) {
            event.stopPropagation();

            if (confirm(`${date} í™˜ìœ¨ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const key = `${CONFIG.CACHE_PREFIX}${date}`;
                localStorage.removeItem(key);
                updateSavedDatesList();
            }
        }

        // í†µí™” ê¸°í˜¸ ê°€ì ¸ì˜¤ê¸°
        function getCurrencySymbol(currency) {
            const symbols = {
                'USD': '$',
                'EUR': 'â‚¬',
                'CHF': 'Fr',
                'KRW': 'â‚©',
                'JPY': 'Â¥',
                'GBP': 'Â£',
                'CNY': 'Â¥',
                'AUD': 'A$',
                'CAD': 'C$',
                'HKD': 'HK$',
                'SGD': 'S$',
                'NZD': 'NZ$',
                'SEK': 'kr',
                'NOK': 'kr',
                'DKK': 'kr',
                'RUB': 'â‚½',
                'INR': 'â‚¹',
                'BRL': 'R$',
                'ZAR': 'R',
                'THB': 'à¸¿',
                'MYR': 'RM',
                'IDR': 'Rp',
                'PHP': 'â‚±',
                'VND': 'â‚«',
                'MXN': 'Mex$',
                'TRY': 'â‚º',
                'PLN': 'zÅ‚',
                'AED': 'Ø¯.Ø¥',
                'SAR': 'SR'
            };
            return symbols[currency] || '';
        }

        // í†µí™” ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        function getCurrencyName(currency) {
            const detailedName = getDetailedCurrencyName(currency);

            if (currency === 'KRW') {
                return 'ì› (KRW)';
            }

            return `${detailedName} (${currency})`;
        }

        // ìƒì„¸ í†µí™” ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (êµ­ê°€ëª… í¬í•¨)
        function getDetailedCurrencyName(code) {
            const detailedNames = {
                'USD': 'ë¯¸êµ­ ë‹¬ëŸ¬',
                'EUR': 'ìœ ë¡œ',
                'JPY': 'ì¼ë³¸ ì—”',
                'GBP': 'ì˜êµ­ íŒŒìš´ë“œ',
                'CHF': 'ìŠ¤ìœ„ìŠ¤ í”„ë‘',
                'CNY': 'ì¤‘êµ­ ìœ„ì•ˆ',
                'AUD': 'í˜¸ì£¼ ë‹¬ëŸ¬',
                'CAD': 'ìºë‚˜ë‹¤ ë‹¬ëŸ¬',
                'HKD': 'í™ì½© ë‹¬ëŸ¬',
                'SGD': 'ì‹±ê°€í¬ë¥´ ë‹¬ëŸ¬',
                'NZD': 'ë‰´ì§ˆëœë“œ ë‹¬ëŸ¬',
                'SEK': 'ìŠ¤ì›¨ë´ í¬ë¡œë‚˜',
                'NOK': 'ë…¸ë¥´ì›¨ì´ í¬ë¡œë„¤',
                'DKK': 'ë´ë§ˆí¬ í¬ë¡œë„¤',
                'RUB': 'ëŸ¬ì‹œì•„ ë£¨ë¸”',
                'INR': 'ì¸ë„ ë£¨í”¼',
                'BRL': 'ë¸Œë¼ì§ˆ í—¤ì•Œ',
                'ZAR': 'ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ëœë“œ',
                'THB': 'íƒœêµ­ ë°”íŠ¸',
                'MYR': 'ë§ë ˆì´ì‹œì•„ ë§ê¹ƒ',
                'IDR': 'ì¸ë„ë„¤ì‹œì•„ ë£¨í”¼ì•„',
                'PHP': 'í•„ë¦¬í•€ í˜ì†Œ',
                'VND': 'ë² íŠ¸ë‚¨ ë™',
                'MXN': 'ë©•ì‹œì½” í˜ì†Œ',
                'TRY': 'íŠ€ë¥´í‚¤ì˜ˆ ë¦¬ë¼',
                'PLN': 'í´ë€ë“œ ì¦ë¡œí‹°',
                'AED': 'ì•„ëì—ë¯¸ë¦¬íŠ¸ ë””ë¥´í•¨',
                'SAR': 'ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë¦¬ì–„',
                'KWD': 'ì¿ ì›¨ì´íŠ¸ ë””ë‚˜ë¥´',
                'BHD': 'ë°”ë ˆì¸ ë””ë‚˜ë¥´',
                'JOD': 'ìš”ë¥´ë‹¨ ë””ë‚˜ë¥´',
                'QAR': 'ì¹´íƒ€ë¥´ ë¦¬ì–„',
                'OMR': 'ì˜¤ë§Œ ë¦¬ì•Œ',
                'EGP': 'ì´ì§‘íŠ¸ íŒŒìš´ë“œ',
                'ILS': 'ì´ìŠ¤ë¼ì—˜ ì…°ì¼ˆ',
                'CLP': 'ì¹ ë ˆ í˜ì†Œ',
                'COP': 'ì½œë¡¬ë¹„ì•„ í˜ì†Œ',
                'ARS': 'ì•„ë¥´í—¨í‹°ë‚˜ í˜ì†Œ',
                'CZK': 'ì²´ì½” ì½”ë£¨ë‚˜',
                'HUF': 'í—ê°€ë¦¬ í¬ë¦°íŠ¸',
                'RON': 'ë£¨ë§ˆë‹ˆì•„ ë ˆìš°',
                'ISK': 'ì•„ì´ìŠ¬ë€ë“œ í¬ë¡œë‚˜',
                'HRK': 'í¬ë¡œì•„í‹°ì•„ ì¿ ë‚˜',
                'BGN': 'ë¶ˆê°€ë¦¬ì•„ ë ˆí”„',
                'KZT': 'ì¹´ìíìŠ¤íƒ„ í…¡ê²Œ',
                'PKR': 'íŒŒí‚¤ìŠ¤íƒ„ ë£¨í”¼',
                'BDT': 'ë°©ê¸€ë¼ë°ì‹œ íƒ€ì¹´',
                'LKR': 'ìŠ¤ë¦¬ë‘ì¹´ ë£¨í”¼',
                'TWD': 'ëŒ€ë§Œ ë‹¬ëŸ¬',
                'FJD': 'í”¼ì§€ ë‹¬ëŸ¬',
                'PGK': 'íŒŒí‘¸ì•„ë‰´ê¸°ë‹ˆ í‚¤ë‚˜',
                'MNT': 'ëª½ê³¨ íˆ¬ê·¸ë¦­',
                'BND': 'ë¸Œë£¨ë‚˜ì´ ë‹¬ëŸ¬',
                'KHR': 'ìº„ë³´ë””ì•„ ë¦¬ì—˜',
                'LAK': 'ë¼ì˜¤ìŠ¤ í‚µ',
                'MMK': 'ë¯¸ì–€ë§ˆ ì°¨íŠ¸',
                'NPR': 'ë„¤íŒ” ë£¨í”¼',
                'ETB': 'ì—í‹°ì˜¤í”¼ì•„ ë¹„ë¥´'
            };

            // ìƒì„¸ ì´ë¦„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ APIì—ì„œ ë°›ì€ ì´ë¦„ ì‚¬ìš©
            if (detailedNames[code]) {
                return detailedNames[code];
            }

            // APIì—ì„œ ë°›ì€ ì´ë¦„ ì‚¬ìš©
            if (allCurrencies[code] && allCurrencies[code] !== code) {
                return allCurrencies[code];
            }

            return code;
        }

        // ê³„ì‚° í•¨ìˆ˜
        function calculate() {
            const date = document.getElementById('date').value;
            const fromCurrency = document.getElementById('fromCurrency').value;
            const amountStr = document.getElementById('amount').value.replace(/,/g, '');
            const amount = parseFloat(amountStr);

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!date) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!amount || amount <= 0) {
                alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!currentRates) {
                alert('í•´ë‹¹ ë‚ ì§œì˜ í™˜ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ í™˜ìœ¨ì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.');
                return;
            }

            // ì„ íƒëœ í†µí™”ë¡œ ë³€í™˜ ê³„ì‚°
            const currencies = ['KRW', ...selectedCurrencies];
            const fromSymbol = getCurrencySymbol(fromCurrency);
            let resultsHTML = '';

            currencies.forEach(toCurrency => {
                // ê°™ì€ í†µí™”ëŠ” ê±´ë„ˆë›°ê¸°
                if (toCurrency === fromCurrency) return;

                let result;
                let appliedRate;

                if (fromCurrency === 'KRW' && toCurrency !== 'KRW') {
                    // ì›í™” â†’ ì™¸í™”
                    appliedRate = currentRates[toCurrency];
                    result = amount / appliedRate;

                } else if (fromCurrency !== 'KRW' && toCurrency === 'KRW') {
                    // ì™¸í™” â†’ ì›í™”
                    appliedRate = currentRates[fromCurrency];
                    result = amount * appliedRate;

                } else if (fromCurrency !== 'KRW' && toCurrency !== 'KRW') {
                    // ì™¸í™” â†’ ì™¸í™”
                    const fromRate = currentRates[fromCurrency];
                    const toRate = currentRates[toCurrency];

                    const amountInKRW = amount * fromRate;
                    result = amountInKRW / toRate;
                    appliedRate = toRate;
                }

                // ê²°ê³¼ í•­ëª© ìƒì„±
                const toSymbol = getCurrencySymbol(toCurrency);
                const rateDisplay = appliedRate ? appliedRate.toFixed(2) : '-';

                resultsHTML += `
                    <div class="result-item">
                        <div class="result-currency">${getCurrencyName(toCurrency)}</div>
                        <div class="result-amount">${toSymbol}${result.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="result-rate">í™˜ìœ¨: ${rateDisplay} ì›</div>
                    </div>
                `;
            });

            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('resultList').innerHTML = resultsHTML;
            document.getElementById('result').classList.add('show');
        }

        // Enter í‚¤ë¡œ ê³„ì‚°
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculate();
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë‚ ì§œ ëª©ë¡ í‘œì‹œ ë° í™˜ìœ¨ ë¡œë“œ
        updateSavedDatesList();
        fetchRatesOnDateChange();
    </script>
</body>
</html>