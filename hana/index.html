<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì¶œ í™˜ìœ¨ ê³„ì‚°ê¸°</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’±</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #008485 0%, #00A896 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .calculator {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 18px;
                margin-bottom: 15px;
            }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 30px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ê³„ì‚°ê¸° ì„¹ì…˜ */
        .calculator-section {
            padding: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-end;  /* í•˜ë‹¨ ì •ë ¬ë¡œ ë†’ì´ ë§ì¶¤ */
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* í™˜ìœ¨ ìœ„ì ¯ */
        .rate-widget {
            background: linear-gradient(135deg, #008485 0%, #00A896 100%);
            border-radius: 16px;
            padding: 25px;
            color: white;
            position: sticky;
            top: 20px;
        }

        .rate-widget-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rate-widget-date {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .rate-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .rate-item:last-child {
            margin-bottom: 0;
        }

        .rate-currency {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .rate-value {
            font-size: 24px;
            font-weight: 700;
        }

        .rate-label {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 3px;
        }

        .api-status {
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 15px;  /* ì•„ë˜ ì—¬ë°± ì¶”ê°€ */
            display: none;
        }

        .api-status.loading {
            display: block;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .api-status.success {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .api-status.cached {
            display: block;
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="date"],
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="date"]:focus,
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #008485;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            padding-right: 40px;
        }

        .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #999;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .clear-btn:hover {
            background: #666;
        }

        /* ê³„ì‚°ê¸° ì„¹ì…˜ */
        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #008485 0%, #00A896 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .result.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .result-header {
            color: #008485;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 14px;
        }

        #resultList {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        @media (max-width: 768px) {
            #resultList {
                grid-template-columns: 1fr;
            }
        }

        .result-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
        }

        .result-item:hover {
            border-color: #008485;
            box-shadow: 0 4px 12px rgba(0, 132, 133, 0.1);
        }

        .result-currency {
            font-size: 13px;
            color: #008485;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .result-amount {
            font-size: 26px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .result-rate {
            font-size: 12px;
            color: #666;
        }

        .info-message {
            background: #e6f7f7;
            border-left: 3px solid #008485;
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            line-height: 1.5;
        }

        .saved-dates {
            margin-top: 15px;
        }

        .saved-dates-toggle {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .saved-dates-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .saved-dates-list {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .saved-dates-list.show {
            display: block;
        }

        .saved-dates-title {
            font-weight: 600;
            color: white;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .saved-date-item {
            padding: 5px 8px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-date-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(3px);
        }

        .delete-date-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .delete-date-btn:hover {
            background: #c82333;
        }

        /* í™”í ì„ íƒ ë²„íŠ¼ (label ì˜†) */
        .currency-select-btn {
            display: inline-block;
            margin-left: 8px;
            padding: 4px 10px;
            background: #008485;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: normal;
        }

        .currency-select-btn:hover {
            background: #00A896;
        }

        /* ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: #333;
        }

        .currency-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .currency-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .currency-checkbox-item:hover {
            background: #e9ecef;
        }

        .currency-checkbox-item input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .currency-checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
            font-size: 13px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <h1>ìˆ˜ì¶œ í™˜ìœ¨ ê³„ì‚°ê¸° (í•˜ë‚˜ì€í–‰)</h1>

        <div class="main-content">
            <!-- ì™¼ìª½: ê³„ì‚°ê¸° ì„¹ì…˜ -->
            <div class="calculator-section">
                <div class="form-group">
                    <label for="date">ë‚ ì§œ</label>
                    <input type="date" id="date" required onchange="fetchRatesOnDateChange()">
                </div>

                <div id="api-status" class="api-status"></div>

                <div class="form-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="fromCurrency">
                            í†µí™” ì„ íƒ
                            <button type="button" class="currency-select-btn" onclick="openCurrencyModal()">í™”í ì„ íƒ</button>
                        </label>
                        <select id="fromCurrency">
                            <option value="KRW">ì› (KRW)</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="amount">ê¸ˆì•¡</label>
                        <div class="input-wrapper">
                            <input type="text" id="amount" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                            <button type="button" class="clear-btn" id="clearAmount">Ã—</button>
                        </div>
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculate()">ê³„ì‚°í•˜ê¸°</button>

                <div class="result" id="result">
                    <div class="result-header">í™˜ì „ ê²°ê³¼</div>
                    <div id="resultList"></div>
                </div>

                <div class="info-message" style="margin-top: 20px;">
                    <strong>ê³„ì‚° ë°©ì‹:</strong><br>
                    â€¢ <strong>ì›í™” ê´€ë ¨:</strong> í•˜ë‚˜ì€í–‰ ì†¡ê¸ˆ í™˜ìœ¨ ì‚¬ìš©<br>
                    â€¢ <strong>ì™¸í™” ê°„:</strong> ëŒ€ë¯¸í™˜ì‚°ìœ¨ ê¸°ë°˜ êµì°¨í™˜ìœ¨(Cross Rate) ì‚¬ìš©<br>
                    <br>
                    ì˜ˆ) EUR 1 = 1.1556 USD, CHF 1 = 1.2424 USD<br>
                    â†’ EUR 1 = (1.2424 / 1.1556) CHF = 1.0751 CHF
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: í™˜ìœ¨ ì •ë³´ ìœ„ì ¯ -->
            <div class="rate-widget">
                <div class="rate-widget-title">ì†¡ê¸ˆ í™˜ìœ¨ (í•˜ë‚˜ì€í–‰)</div>
                <div class="rate-widget-date" id="widget-date">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>

                <!-- í™˜ìœ¨ í•­ëª©ë“¤ì€ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->

                <!-- ì €ì¥ëœ ë‚ ì§œ ëª©ë¡ -->
                <div class="saved-dates">
                    <button class="saved-dates-toggle" onclick="toggleSavedDates()">
                        ì €ì¥ëœ í™˜ìœ¨ ë‚ ì§œ ë³´ê¸° (<span id="saved-count">0</span>)
                    </button>
                    <div class="saved-dates-list" id="saved-dates-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- í™”í ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="currencyModal" onclick="closeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">ìì£¼ ì“°ëŠ” í™”í ì„ íƒ</h2>
                <button class="modal-close-btn" onclick="closeCurrencyModal()">&times;</button>
            </div>
            <div id="currency-checkboxes" class="currency-checkboxes">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>
    </div>

    <script>
        // í˜„ì¬ ë¡œë“œëœ í™˜ìœ¨ ë°ì´í„°
        let currentRates = null;
        let allCurrencies = {}; // ëª¨ë“  í™”í ì •ë³´ ì €ì¥
        let selectedCurrencies = ['USD', 'EUR', 'CHF']; // ê¸°ë³¸ ì„ íƒëœ í™”í

        // ì´ˆê¸°í™”
        const today = new Date();
        const dateInput = document.getElementById('date');
        dateInput.valueAsDate = today;
        // ì˜¤ëŠ˜ ë‚ ì§œê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ max ì†ì„± ì„¤ì •
        dateInput.max = today.toISOString().split('T')[0];

        // localStorageì—ì„œ ì„ í˜¸ í™”í ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSelectedCurrencies() {
            const saved = localStorage.getItem('selectedCurrencies_hana');
            if (saved) {
                selectedCurrencies = JSON.parse(saved);
            }

            // í™”í ì´ë¦„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            const savedNames = localStorage.getItem('currencyNames_hana');
            if (savedNames) {
                allCurrencies = JSON.parse(savedNames);
            }
        }

        // localStorageì— ì„ í˜¸ í™”í ì €ì¥
        function saveSelectedCurrencies() {
            localStorage.setItem('selectedCurrencies_hana', JSON.stringify(selectedCurrencies));
        }

        // ëª¨ë‹¬ ì—´ê¸°
        function openCurrencyModal() {
            const modal = document.getElementById('currencyModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ë°©ì§€
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeCurrencyModal() {
            const modal = document.getElementById('currencyModal');
            modal.classList.remove('show');
            document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µì›
        }

        // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
        function closeModalOnOverlay(event) {
            if (event.target.id === 'currencyModal') {
                closeCurrencyModal();
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCurrencyModal();
            }
        });

        // ì²´í¬ë°•ìŠ¤ ë Œë”ë§
        function renderCurrencyCheckboxes() {
            const container = document.getElementById('currency-checkboxes');

            if (Object.keys(allCurrencies).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ í™˜ìœ¨ì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”</p>';
                return;
            }

            let html = '';
            const sortedCurrencies = Object.keys(allCurrencies).sort();

            sortedCurrencies.forEach(code => {
                const detailedName = getDetailedCurrencyName(code);
                const checked = selectedCurrencies.includes(code) ? 'checked' : '';
                html += `
                    <div class="currency-checkbox-item">
                        <input type="checkbox" id="curr-${code}" value="${code}" ${checked} onchange="updateCurrencySelections()">
                        <label for="curr-${code}">${detailedName} (${code})</label>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ì²˜ë¦¬
        function updateCurrencySelections() {
            const checkboxes = document.querySelectorAll('#currency-checkboxes input[type="checkbox"]');
            selectedCurrencies = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedCurrencies.push(checkbox.value);
                }
            });

            saveSelectedCurrencies();
            updateCurrencyDropdown();
            updateRateWidget();
        }

        // í†µí™” ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateCurrencyDropdown() {
            const dropdown = document.getElementById('fromCurrency');
            const currentValue = dropdown.value;

            // KRWëŠ” í•­ìƒ í¬í•¨
            let html = '<option value="KRW">ì› (KRW)</option>';

            selectedCurrencies.forEach(code => {
                const detailedName = getDetailedCurrencyName(code);
                html += `<option value="${code}">${detailedName} (${code})</option>`;
            });

            dropdown.innerHTML = html;

            // ì´ì „ ì„ íƒ ê°’ ìœ ì§€ (ê°€ëŠ¥í•œ ê²½ìš°)
            if (currentValue === 'KRW' || selectedCurrencies.includes(currentValue)) {
                dropdown.value = currentValue;
            }
        }

        // í™˜ìœ¨ ìœ„ì ¯ ì—…ë°ì´íŠ¸ (ì„ íƒëœ í™”íë§Œ í‘œì‹œ)
        function updateRateWidget() {
            const widgetContainer = document.querySelector('.rate-widget');
            const date = document.getElementById('date').value;

            // ê¸°ì¡´ í™˜ìœ¨ í•­ëª© ì œê±° (ì €ì¥ëœ ë‚ ì§œ ë¶€ë¶„ ì œì™¸)
            const existingItems = widgetContainer.querySelectorAll('.rate-item');
            existingItems.forEach(item => item.remove());

            if (!currentRates || selectedCurrencies.length === 0) {
                return;
            }

            // ë‚ ì§œ í‘œì‹œ ë°”ë¡œ ë‹¤ìŒì— í™˜ìœ¨ í•­ëª© ì¶”ê°€
            const dateElement = document.getElementById('widget-date');

            selectedCurrencies.forEach(code => {
                const rate = currentRates[code];
                const usdRate = currentRates[`${code}_usd`];
                const detailedName = getDetailedCurrencyName(code);
                const symbol = getCurrencySymbol(code);

                const rateItem = document.createElement('div');
                rateItem.className = 'rate-item';
                rateItem.innerHTML = `
                    <div class="rate-currency">${symbol} ${detailedName} (${code})</div>
                    <div class="rate-value">${rate ? rate.toFixed(2) : '-'}</div>
                    <div class="rate-label">ì› (ì†¡ê¸ˆ ë³´ë‚¼ ë•Œ)</div>
                    <div class="rate-label" style="font-size: 10px; margin-top: 3px; opacity: 0.7;">ëŒ€ë¯¸í™˜ì‚°ìœ¨: ${usdRate ? usdRate.toFixed(4) : '-'}</div>
                `;

                // ì €ì¥ëœ ë‚ ì§œ ì„¹ì…˜ ì „ì— ì‚½ì…
                const savedDatesSection = widgetContainer.querySelector('.saved-dates');
                widgetContainer.insertBefore(rateItem, savedDatesSection);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        loadSelectedCurrencies();

        // X ë²„íŠ¼ í´ë¦­ ì‹œ ê¸ˆì•¡ ì§€ìš°ê¸°
        const clearBtn = document.getElementById('clearAmount');
        document.getElementById('clearAmount').addEventListener('click', function() {
            document.getElementById('amount').value = '';
            clearBtn.style.display = 'none';
            document.getElementById('amount').focus();
        });

        // ê¸ˆì•¡ ì…ë ¥ í•„ë“œì— ì‰¼í‘œ ì¶”ê°€
        const amountInput = document.getElementById('amount');

        // X ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
        function updateClearButton() {
            if (amountInput.value) {
                clearBtn.style.display = 'flex';
            } else {
                clearBtn.style.display = 'none';
            }
        }

        amountInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/,/g, '');
            updateClearButton();

            // ìˆ«ì, ì†Œìˆ˜ì ë§Œ í—ˆìš©
            if (value && !/^[\d.]*$/.test(value)) {
                value = value.replace(/[^\d.]/g, '');
            }

            // ì†Œìˆ˜ì ì´ ìˆëŠ”ì§€ í™•ì¸
            if (value.includes('.')) {
                const parts = value.split('.');
                const integerPart = parts[0];
                const decimalPart = parts[1] || '';

                // ì •ìˆ˜ ë¶€ë¶„ì—ë§Œ ì‰¼í‘œ ì¶”ê°€
                if (integerPart) {
                    const formatted = parseInt(integerPart).toLocaleString('en-US');
                    e.target.value = formatted + '.' + decimalPart;
                } else {
                    e.target.value = '.' + decimalPart;
                }
            } else if (value && !isNaN(value)) {
                e.target.value = parseInt(value).toLocaleString('en-US');
            } else {
                e.target.value = value;
            }
        });

        amountInput.addEventListener('blur', function(e) {
            let value = e.target.value.replace(/,/g, '');
            if (value && !isNaN(value) && value !== '.') {
                e.target.value = parseFloat(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            updateClearButton();
        });

        amountInput.addEventListener('focus', function(e) {
            updateClearButton();
        });

        // ìœ„ì ¯ ì—…ë°ì´íŠ¸
        function updateWidget(date, rates) {
            document.getElementById('widget-date').textContent = date;

            // ê³„ì‚°ì— ì‚¬ìš©í•  í˜„ì¬ í™˜ìœ¨ ì €ì¥
            currentRates = rates;

            // ì²´í¬ë°•ìŠ¤ì™€ ìœ„ì ¯ ì—…ë°ì´íŠ¸
            renderCurrencyCheckboxes();
            updateCurrencyDropdown();
            updateRateWidget();
        }

        // ë‚ ì§œ ë³€ê²½ ì‹œ í™˜ìœ¨ ìë™ ë¶ˆëŸ¬ì˜¤ê¸° (ìºì‹œ í™•ì¸ í›„ API í˜¸ì¶œ)
        function fetchRatesOnDateChange() {
            const dateInput = document.getElementById('date');
            const date = dateInput.value;

            if (!date) {
                return;
            }

            // ë¯¸ë˜ ë‚ ì§œ ê²€ì¦
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // ì‹œê°„ ì œê±°í•˜ì—¬ ë‚ ì§œë§Œ ë¹„êµ
            selectedDate.setHours(0, 0, 0, 0);

            if (selectedDate > today) {
                showStatus('error', 'ë¯¸ë˜ì˜ í™˜ìœ¨ì„ ì•Œ ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤.');
                // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë¦¬ì…‹
                dateInput.valueAsDate = today;
                return;
            }

            const key = `exchangeRate_hana_${date}`;
            const cachedRates = localStorage.getItem(key);

            // ìºì‹œì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìºì‹œ ì‚¬ìš©
            if (cachedRates) {
                const rates = JSON.parse(cachedRates);
                updateWidget(date, rates);
                showStatus('cached', `ìºì‹œì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ (${date})`);
                return;
            }

            // ìºì‹œì— ì—†ìœ¼ë©´ API í˜¸ì¶œ
            fetchRatesFromAPI(date);
        }

        // API ìƒíƒœ í‘œì‹œ
        function showStatus(type, message) {
            const statusEl = document.getElementById('api-status');
            statusEl.className = `api-status ${type}`;
            statusEl.textContent = message;

            // ì„±ê³µ/ìºì‹œ ë©”ì‹œì§€ëŠ” 3ì´ˆ í›„ ìˆ¨ê¹€
            if (type === 'success' || type === 'cached') {
                setTimeout(() => {
                    statusEl.className = 'api-status';
                }, 3000);
            }
        }

        // í†µí™” ì½”ë“œ ì¶”ì¶œ (ê´„í˜¸ ì•ˆì— ìˆëŠ” ì½”ë“œ ë˜ëŠ” í‚¤ì›Œë“œë¡œ ë§¤ì¹­)
        function extractCurrencyCode(currencyText) {
            const codeMatch = currencyText.match(/\(([A-Z]{3})\)/);
            if (codeMatch) return codeMatch[1];

            // í‚¤ì›Œë“œ ë§¤ì¹­
            const mapping = {
                'ë¯¸êµ­': 'USD', 'ì¼ë³¸': 'JPY', 'ìœ ë¡œ': 'EUR', 'ì˜êµ­': 'GBP', 'ìŠ¤ìœ„ìŠ¤': 'CHF',
                'ì¤‘êµ­': 'CNY', 'í˜¸ì£¼': 'AUD', 'ìºë‚˜ë‹¤': 'CAD', 'í™ì½©': 'HKD', 'ì‹±ê°€í¬ë¥´': 'SGD',
                'ë‰´ì§ˆëœë“œ': 'NZD', 'ìŠ¤ì›¨ë´': 'SEK', 'ë…¸ë¥´ì›¨ì´': 'NOK', 'ë´ë§ˆí¬': 'DKK',
                'ëŸ¬ì‹œì•„': 'RUB', 'ì¸ë„': 'INR', 'ë¸Œë¼ì§ˆ': 'BRL', 'ë‚¨ì•„ê³µ': 'ZAR', 'íƒœêµ­': 'THB',
                'ë§ë ˆì´ì‹œì•„': 'MYR', 'ì¸ë„ë„¤ì‹œì•„': 'IDR', 'í•„ë¦¬í•€': 'PHP', 'ë² íŠ¸ë‚¨': 'VND',
                'ë©•ì‹œì½”': 'MXN', 'í„°í‚¤': 'TRY', 'í´ë€ë“œ': 'PLN', 'UAE': 'AED', 'ì‚¬ìš°ë””': 'SAR',
                'ì¿ ì›¨ì´íŠ¸': 'KWD', 'ë°”ë ˆì¸': 'BHD', 'ìš”ë¥´ë‹¨': 'JOD', 'ì¹´íƒ€ë¥´': 'QAR', 'ì˜¤ë§Œ': 'OMR',
                'ì´ì§‘íŠ¸': 'EGP', 'ì´ìŠ¤ë¼ì—˜': 'ILS', 'ì¹ ë ˆ': 'CLP', 'ì½œë¡¬ë¹„ì•„': 'COP',
                'ì•„ë¥´í—¨í‹°ë‚˜': 'ARS', 'ì²´ì½”': 'CZK', 'í—ê°€ë¦¬': 'HUF', 'ë£¨ë§ˆë‹ˆì•„': 'RON',
                'ëŒ€ë§Œ': 'TWD', 'ëª½ê³¨': 'MNT', 'íŒŒí‚¤ìŠ¤íƒ„': 'PKR', 'ë°©ê¸€ë¼ë°ì‹œ': 'BDT'
            };

            for (const [keyword, code] of Object.entries(mapping)) {
                if (currencyText.includes(keyword)) return code;
            }

            return null;
        }

        // HTMLì—ì„œ í™˜ìœ¨ ë°ì´í„° ì¶”ì¶œ í—¬í¼ í•¨ìˆ˜ (ëª¨ë“  í™”í)
        function extractRatesFromHtml(html, extractType) {
            console.log(`[extractRatesFromHtml] extractType: ${extractType}, HTML length: ${html.length}`);

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const tables = doc.querySelectorAll('table');

            console.log(`[extractRatesFromHtml] í…Œì´ë¸” ê°œìˆ˜: ${tables.length}`);

            const data = {};
            const currencyNames = {};

            tables.forEach((table, tableIndex) => {
                const rows = table.querySelectorAll('tbody tr');
                console.log(`[extractRatesFromHtml] í…Œì´ë¸” ${tableIndex}: ${rows.length}ê°œ í–‰`);

                rows.forEach((row, rowIndex) => {
                    const cells = row.querySelectorAll('td');

                    // ì²« ë²ˆì§¸ í–‰ì˜ ì…€ ê°œìˆ˜ í™•ì¸
                    if (rowIndex === 0) {
                        console.log(`[extractRatesFromHtml] í…Œì´ë¸” ${tableIndex} ì²« í–‰ ì…€ ê°œìˆ˜: ${cells.length}`);
                        if (cells.length > 0) {
                            const cellTexts = Array.from(cells).map(c => c.textContent.trim().substring(0, 20));
                            console.log(`[extractRatesFromHtml] ì²« í–‰ ì…€ ë‚´ìš©:`, cellTexts);
                        }
                    }

                    let cellIndex;
                    let minCells;

                    if (extractType === 'rate') {
                        // ì†¡ê¸ˆí™˜ìœ¨ ì¶”ì¶œ (mall1501)
                        if (cells.length >= 11) {
                            cellIndex = 5;  // ì†¡ê¸ˆ ë³´ë‚¼ ë•Œ
                            minCells = 11;
                        } else {
                            cellIndex = 3;  // ì´ì „ í˜•ì‹ (9ê°œ ì»¬ëŸ¼)
                            minCells = 9;
                        }
                    } else {
                        // ëŒ€ë¯¸í™˜ì‚°ìœ¨ ì¶”ì¶œ (mall1502)
                        if (cells.length >= 9) {
                            cellIndex = 8;
                            minCells = 9;
                        } else if (cells.length >= 2) {
                            cellIndex = 1;
                            minCells = 2;
                        } else {
                            return;
                        }
                    }

                    if (cells.length >= minCells) {
                        const currencyText = cells[0].textContent.trim();
                        const currencyCode = extractCurrencyCode(currencyText);

                        if (currencyCode) {
                            const valueText = cells[cellIndex].textContent.trim();
                            const value = parseFloat(valueText.replace(/,/g, ''));

                            if (!isNaN(value) && value > 0) {
                                data[currencyCode] = value;
                                currencyNames[currencyCode] = currencyText;
                            }
                        }
                    }
                });
            });

            return { data, currencyNames };
        }

        // í•˜ë‚˜ì€í–‰ HTML íŒŒì‹± í•¨ìˆ˜ (ë‘ í˜ì´ì§€ ë°ì´í„° ê²°í•©)
        function parseHanaBank(mall1501Html, mall1502Html, date) {
            console.log('ì†¡ê¸ˆ í™˜ìœ¨ ì¶”ì¶œ ì‹œì‘ (mall1501)...');
            const sendingResult = extractRatesFromHtml(mall1501Html, 'rate');
            console.log('ì¶”ì¶œëœ ì†¡ê¸ˆ ë³´ë‚¼ ë•Œ í™˜ìœ¨:', sendingResult.data);

            console.log('ëŒ€ë¯¸í™˜ì‚°ìœ¨ ì¶”ì¶œ ì‹œì‘ (mall1502)...');
            const usdResult = extractRatesFromHtml(mall1502Html, 'usd');
            console.log('ì¶”ì¶œëœ ëŒ€ë¯¸í™˜ì‚°ìœ¨:', usdResult.data);

            // ë°ì´í„° í™•ì¸
            if (!sendingResult.data.USD) {
                console.error('ì†¡ê¸ˆ í™˜ìœ¨ ì¶”ì¶œ ì‹¤íŒ¨:', sendingResult.data);
                throw new Error('ì†¡ê¸ˆ í™˜ìœ¨ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }

            if (!usdResult.data.USD) {
                console.error('ëŒ€ë¯¸í™˜ì‚°ìœ¨ ì¶”ì¶œ ì‹¤íŒ¨:', usdResult.data);
                throw new Error('ëŒ€ë¯¸í™˜ì‚°ìœ¨ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }

            // ë‘ ë°ì´í„°ë¥¼ ê²°í•© (ëª¨ë“  í™”í)
            const rates = {};
            const combinedCurrencyNames = { ...sendingResult.currencyNames, ...usdResult.currencyNames };

            // ì†¡ê¸ˆ í™˜ìœ¨ ì¶”ê°€
            for (const [code, rate] of Object.entries(sendingResult.data)) {
                rates[code] = rate;
            }

            // ëŒ€ë¯¸í™˜ì‚°ìœ¨ ì¶”ê°€ (_usd ì ‘ë¯¸ì‚¬ ì‚¬ìš©)
            for (const [code, rate] of Object.entries(usdResult.data)) {
                rates[`${code}_usd`] = rate;
            }

            // í™”í ì´ë¦„ ì •ë³´ë¥¼ ì „ì—­ ë³€ìˆ˜ì™€ localStorageì— ì €ì¥
            allCurrencies = combinedCurrencyNames;
            const currNamesKey = `currencyNames_hana`;
            localStorage.setItem(currNamesKey, JSON.stringify(combinedCurrencyNames));

            // localStorageì— ìºì‹œ ì €ì¥
            const key = `exchangeRate_hana_${date}`;
            localStorage.setItem(key, JSON.stringify(rates));

            // ìœ„ì ¯ ì—…ë°ì´íŠ¸
            updateWidget(date, rates);

            showStatus('success', 'í•˜ë‚˜ì€í–‰ í™˜ìœ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
            updateSavedDatesList();
            return rates;
        }

        // í•˜ë‚˜ì€í–‰ì—ì„œ í™˜ìœ¨ ë¶ˆëŸ¬ì˜¤ê¸° (mall1501ê³¼ mall1502ì—ì„œ ë°ì´í„° ê²°í•©)
        function fetchRatesFromAPI(date) {
            showStatus('loading', 'í•˜ë‚˜ì€í–‰ì—ì„œ í™˜ìœ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

            // mall1501(ì†¡ê¸ˆ í™˜ìœ¨)ê³¼ mall1502(ëŒ€ë¯¸í™˜ì‚°ìœ¨)ë¥¼ ë™ì‹œì— í˜¸ì¶œ
            const mall1501Promise = fetch(`proxy.php?date=${date}&page=mall1501`);
            const mall1502Promise = fetch(`proxy.php?date=${date}&page=mall1502`);

            Promise.all([mall1501Promise, mall1502Promise])
                .then(responses => {
                    if (!responses[0].ok || !responses[1].ok) {
                        throw new Error('í”„ë¡ì‹œ ì‘ë‹µ ì˜¤ë¥˜');
                    }
                    return Promise.all([responses[0].text(), responses[1].text()]);
                })
                .then(([mall1501Html, mall1502Html]) => {
                    console.log('í•˜ë‚˜ì€í–‰ ë°ì´í„° ë¡œë“œ ì„±ê³µ');
                    console.log('ì†¡ê¸ˆ í™˜ìœ¨(mall1501) HTML ê¸¸ì´:', mall1501Html.length);
                    console.log('ëŒ€ë¯¸í™˜ì‚°ìœ¨(mall1502) HTML ê¸¸ì´:', mall1502Html.length);
                    parseHanaBank(mall1501Html, mall1502Html, date);
                })
                .catch(error => {
                    console.error('í•˜ë‚˜ì€í–‰ í™˜ìœ¨ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showStatus('error', 'í™˜ìœ¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
        }


        // ì €ì¥ëœ ë‚ ì§œ í† ê¸€
        function toggleSavedDates() {
            const list = document.getElementById('saved-dates-list');
            list.classList.toggle('show');
        }

        // ì €ì¥ëœ ë‚ ì§œ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateSavedDatesList() {
            const container = document.getElementById('saved-dates-list');
            const countSpan = document.getElementById('saved-count');
            const dates = [];

            // localStorageì—ì„œ ëª¨ë“  í™˜ìœ¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('exchangeRate_hana_')) {
                    const date = key.replace('exchangeRate_hana_', '');
                    dates.push(date);
                }
            }

            // ê°œìˆ˜ ì—…ë°ì´íŠ¸
            countSpan.textContent = dates.length;

            if (dates.length === 0) {
                container.innerHTML = '';
                return;
            }

            // ë‚ ì§œ ì •ë ¬ (ìµœì‹ ìˆœ)
            dates.sort().reverse();

            let html = '<div class="saved-dates-title">ì €ì¥ëœ í™˜ìœ¨ ë‚ ì§œ</div>';
            dates.forEach(date => {
                html += `
                    <div class="saved-date-item">
                        <span onclick="loadSavedDate('${date}')">${date}</span>
                        <button class="delete-date-btn" onclick="deleteSavedDate('${date}', event)">ì‚­ì œ</button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ì €ì¥ëœ ë‚ ì§œ í´ë¦­ ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSavedDate(date) {
            document.getElementById('date').value = date;
            fetchRatesOnDateChange();
        }

        // ì €ì¥ëœ ë‚ ì§œ ì‚­ì œ
        function deleteSavedDate(date, event) {
            event.stopPropagation();

            if (confirm(`${date} í™˜ìœ¨ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const key = `exchangeRate_hana_${date}`;
                localStorage.removeItem(key);
                updateSavedDatesList();
            }
        }

        // í†µí™” ê¸°í˜¸ ê°€ì ¸ì˜¤ê¸°
        function getCurrencySymbol(currency) {
            const symbols = {
                'USD': '$',
                'EUR': 'â‚¬',
                'CHF': 'Fr',
                'KRW': 'â‚©',
                'JPY': 'Â¥',
                'GBP': 'Â£',
                'CNY': 'Â¥',
                'AUD': 'A$',
                'CAD': 'C$',
                'HKD': 'HK$',
                'SGD': 'S$',
                'NZD': 'NZ$',
                'SEK': 'kr',
                'NOK': 'kr',
                'DKK': 'kr',
                'RUB': 'â‚½',
                'INR': 'â‚¹',
                'BRL': 'R$',
                'ZAR': 'R',
                'THB': 'à¸¿',
                'MYR': 'RM',
                'IDR': 'Rp',
                'PHP': 'â‚±',
                'VND': 'â‚«',
                'MXN': 'Mex$',
                'TRY': 'â‚º',
                'PLN': 'zÅ‚',
                'AED': 'Ø¯.Ø¥',
                'SAR': 'SR'
            };
            return symbols[currency] || '';
        }

        // í†µí™” ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        function getCurrencyName(currency) {
            const detailedName = getDetailedCurrencyName(currency);

            if (currency === 'KRW') {
                return 'ì› (KRW)';
            }

            return `${detailedName} (${currency})`;
        }

        // ìƒì„¸ í†µí™” ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (êµ­ê°€ëª… í¬í•¨)
        function getDetailedCurrencyName(code) {
            const detailedNames = {
                'USD': 'ë¯¸êµ­ ë‹¬ëŸ¬',
                'EUR': 'ìœ ë¡œ',
                'JPY': 'ì¼ë³¸ ì—”',
                'GBP': 'ì˜êµ­ íŒŒìš´ë“œ',
                'CHF': 'ìŠ¤ìœ„ìŠ¤ í”„ë‘',
                'CNY': 'ì¤‘êµ­ ìœ„ì•ˆ',
                'AUD': 'í˜¸ì£¼ ë‹¬ëŸ¬',
                'CAD': 'ìºë‚˜ë‹¤ ë‹¬ëŸ¬',
                'HKD': 'í™ì½© ë‹¬ëŸ¬',
                'SGD': 'ì‹±ê°€í¬ë¥´ ë‹¬ëŸ¬',
                'NZD': 'ë‰´ì§ˆëœë“œ ë‹¬ëŸ¬',
                'SEK': 'ìŠ¤ì›¨ë´ í¬ë¡œë‚˜',
                'NOK': 'ë…¸ë¥´ì›¨ì´ í¬ë¡œë„¤',
                'DKK': 'ë´ë§ˆí¬ í¬ë¡œë„¤',
                'RUB': 'ëŸ¬ì‹œì•„ ë£¨ë¸”',
                'INR': 'ì¸ë„ ë£¨í”¼',
                'BRL': 'ë¸Œë¼ì§ˆ í—¤ì•Œ',
                'ZAR': 'ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ëœë“œ',
                'THB': 'íƒœêµ­ ë°”íŠ¸',
                'MYR': 'ë§ë ˆì´ì‹œì•„ ë§ê¹ƒ',
                'IDR': 'ì¸ë„ë„¤ì‹œì•„ ë£¨í”¼ì•„',
                'PHP': 'í•„ë¦¬í•€ í˜ì†Œ',
                'VND': 'ë² íŠ¸ë‚¨ ë™',
                'MXN': 'ë©•ì‹œì½” í˜ì†Œ',
                'TRY': 'íŠ€ë¥´í‚¤ì˜ˆ ë¦¬ë¼',
                'PLN': 'í´ë€ë“œ ì¦ë¡œí‹°',
                'AED': 'ì•„ëì—ë¯¸ë¦¬íŠ¸ ë””ë¥´í•¨',
                'SAR': 'ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë¦¬ì–„',
                'KWD': 'ì¿ ì›¨ì´íŠ¸ ë””ë‚˜ë¥´',
                'BHD': 'ë°”ë ˆì¸ ë””ë‚˜ë¥´',
                'JOD': 'ìš”ë¥´ë‹¨ ë””ë‚˜ë¥´',
                'QAR': 'ì¹´íƒ€ë¥´ ë¦¬ì–„',
                'OMR': 'ì˜¤ë§Œ ë¦¬ì•Œ',
                'EGP': 'ì´ì§‘íŠ¸ íŒŒìš´ë“œ',
                'ILS': 'ì´ìŠ¤ë¼ì—˜ ì…°ì¼ˆ',
                'CLP': 'ì¹ ë ˆ í˜ì†Œ',
                'COP': 'ì½œë¡¬ë¹„ì•„ í˜ì†Œ',
                'ARS': 'ì•„ë¥´í—¨í‹°ë‚˜ í˜ì†Œ',
                'CZK': 'ì²´ì½” ì½”ë£¨ë‚˜',
                'HUF': 'í—ê°€ë¦¬ í¬ë¦°íŠ¸',
                'RON': 'ë£¨ë§ˆë‹ˆì•„ ë ˆìš°',
                'ISK': 'ì•„ì´ìŠ¬ë€ë“œ í¬ë¡œë‚˜',
                'HRK': 'í¬ë¡œì•„í‹°ì•„ ì¿ ë‚˜',
                'BGN': 'ë¶ˆê°€ë¦¬ì•„ ë ˆí”„',
                'KZT': 'ì¹´ìíìŠ¤íƒ„ í…¡ê²Œ',
                'PKR': 'íŒŒí‚¤ìŠ¤íƒ„ ë£¨í”¼',
                'BDT': 'ë°©ê¸€ë¼ë°ì‹œ íƒ€ì¹´',
                'LKR': 'ìŠ¤ë¦¬ë‘ì¹´ ë£¨í”¼',
                'TWD': 'ëŒ€ë§Œ ë‹¬ëŸ¬',
                'FJD': 'í”¼ì§€ ë‹¬ëŸ¬',
                'PGK': 'íŒŒí‘¸ì•„ë‰´ê¸°ë‹ˆ í‚¤ë‚˜',
                'MNT': 'ëª½ê³¨ íˆ¬ê·¸ë¦­',
                'BND': 'ë¸Œë£¨ë‚˜ì´ ë‹¬ëŸ¬',
                'KHR': 'ìº„ë³´ë””ì•„ ë¦¬ì—˜',
                'LAK': 'ë¼ì˜¤ìŠ¤ í‚µ',
                'MMK': 'ë¯¸ì–€ë§ˆ ì°¨íŠ¸',
                'NPR': 'ë„¤íŒ” ë£¨í”¼',
                'ETB': 'ì—í‹°ì˜¤í”¼ì•„ ë¹„ë¥´'
            };

            // ìƒì„¸ ì´ë¦„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ APIì—ì„œ ë°›ì€ ì´ë¦„ ì‚¬ìš©
            if (detailedNames[code]) {
                return detailedNames[code];
            }

            // APIì—ì„œ ë°›ì€ ì´ë¦„ ì‚¬ìš©
            if (allCurrencies[code] && allCurrencies[code] !== code) {
                return allCurrencies[code];
            }

            return code;
        }

        // ê³„ì‚° í•¨ìˆ˜
        function calculate() {
            const date = document.getElementById('date').value;
            const fromCurrency = document.getElementById('fromCurrency').value;
            const amountStr = document.getElementById('amount').value.replace(/,/g, '');
            const amount = parseFloat(amountStr);

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!date) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!amount || amount <= 0) {
                alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!currentRates) {
                alert('í•´ë‹¹ ë‚ ì§œì˜ í™˜ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ í™˜ìœ¨ì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.');
                return;
            }

            // ì„ íƒëœ í†µí™”ë¡œ ë³€í™˜ ê³„ì‚°
            const currencies = ['KRW', ...selectedCurrencies];
            const fromSymbol = getCurrencySymbol(fromCurrency);
            let resultsHTML = '';

            currencies.forEach(toCurrency => {
                // ê°™ì€ í†µí™”ëŠ” ê±´ë„ˆë›°ê¸°
                if (toCurrency === fromCurrency) return;

                let result;
                let appliedRate;
                let rateInfo = '';

                // ì›í™”ê°€ í¬í•¨ëœ ê²½ìš°: í•˜ë‚˜ì€í–‰ í™˜ìœ¨ ì‚¬ìš©
                if (fromCurrency === 'KRW' || toCurrency === 'KRW') {
                    if (fromCurrency === 'KRW' && toCurrency !== 'KRW') {
                        // ì›í™” â†’ ì™¸í™”
                        appliedRate = currentRates[toCurrency];
                        result = amount / appliedRate;
                        rateInfo = `ì†¡ê¸ˆ í™˜ìœ¨: ${appliedRate.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ì›`;

                    } else if (fromCurrency !== 'KRW' && toCurrency === 'KRW') {
                        // ì™¸í™” â†’ ì›í™”
                        appliedRate = currentRates[fromCurrency];
                        result = amount * appliedRate;
                        rateInfo = `ì†¡ê¸ˆ í™˜ìœ¨: ${appliedRate.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ì›`;
                    }
                } else {
                    // ì™¸í™” â†’ ì™¸í™”: ëŒ€ë¯¸í™˜ì‚°ìœ¨(êµì°¨í™˜ìœ¨) ì‚¬ìš©
                    // ëŒ€ë¯¸í™˜ì‚°ìœ¨ ì˜ë¯¸: 1 ì™¸í™” = X USD
                    if (fromCurrency === 'USD') {
                        // USD â†’ ì™¸í™”
                        const toUsdRate = currentRates[`${toCurrency}_usd`];
                        result = amount / toUsdRate; // 1 EUR = 1.1556 USDì´ë©´, 1 USD = 1/1.1556 EUR
                        rateInfo = `êµì°¨í™˜ìœ¨: 1 USD = ${(1/toUsdRate).toFixed(4)} ${toCurrency}`;
                    } else if (toCurrency === 'USD') {
                        // ì™¸í™” â†’ USD
                        const fromUsdRate = currentRates[`${fromCurrency}_usd`];
                        result = amount * fromUsdRate; // 1 EUR = 1.1556 USD
                        rateInfo = `êµì°¨í™˜ìœ¨: 1 ${fromCurrency} = ${fromUsdRate.toFixed(4)} USD`;
                    } else {
                        // ì™¸í™” â†’ USD â†’ ì™¸í™”
                        const fromUsdRate = currentRates[`${fromCurrency}_usd`];
                        const toUsdRate = currentRates[`${toCurrency}_usd`];
                        const crossRate = fromUsdRate / toUsdRate; // 1 EUR = 1.1556 USD, 1 CHF = 1.0751 USD -> 1 EUR = 1.1556/1.0751 CHF
                        result = amount * crossRate;
                        rateInfo = `êµì°¨í™˜ìœ¨: 1 ${fromCurrency} = ${crossRate.toFixed(4)} ${toCurrency}`;
                    }
                }

                // ê²°ê³¼ í•­ëª© ìƒì„±
                const toSymbol = getCurrencySymbol(toCurrency);

                resultsHTML += `
                    <div class="result-item">
                        <div class="result-currency">${getCurrencyName(toCurrency)}</div>
                        <div class="result-amount">${toSymbol}${result.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="result-rate">${rateInfo}</div>
                    </div>
                `;
            });

            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('resultList').innerHTML = resultsHTML;
            document.getElementById('result').classList.add('show');
        }

        // Enter í‚¤ë¡œ ê³„ì‚°
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculate();
            }
        });

        // ë°±ìŠ¬ë˜ì‹œ(\) í‚¤ë¡œ ê³„ì‚°ê¸° í† ê¸€
        document.addEventListener('keydown', function(e) {
            if (e.key === '\\') {
                e.preventDefault();
                window.parent.postMessage('toggleCalculator', '*');
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë‚ ì§œ ëª©ë¡ í‘œì‹œ ë° í™˜ìœ¨ ë¡œë“œ
        updateSavedDatesList();
        fetchRatesOnDateChange();
    </script>
</body>
</html>
